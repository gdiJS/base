unit wmipc;

interface

uses
  Windows, classes, SysUtils, Messages;
  {
type
  TCopyDataStruct = record
    dwData: DWORD;
    cbData: DWORD;
    lpData: Pointer;
  end;
 {
  TCopyDataStruct = packed record
    dwData: DWORD_PTR;
    cbData: DWORD_PTR;
    lpData: Pointer;
  end;
  }

procedure wm_sendstringex(sender: HWND; target: hwnd; strtosend: string);

procedure wm_sendstring(sender: HWND; title: string; strtosend: string);

procedure wm_sendcommand(window: string; _message, command: Cardinal; const param: Cardinal = 0);

implementation

procedure wm_sendcommand(window: string; _message, command: Cardinal; const param: Cardinal = 0);
var
  receiverHandle: THandle;
  res: pdword_ptr;
begin
  try
    receiverHandle := FindWindow(nil, PChar(window));
    if receiverHandle <> 0 then
      SendMessageTimeOut(receiverHandle, _message, command, param, SMTO_NORMAL or SMTO_ABORTIFHUNG, 100, res);
  except
    on e: exception do
    begin

    end;
  end;
end;

procedure wm_sendstring(sender: HWND; title: string; strtosend: string);
var
  copyDataStruct: TCopyDataStruct;
  receiverHandle: THandle;
  res: pdword_ptr;
begin
  try
    copyDataStruct.dwData := 0;
    copyDataStruct.cbData := 1 + Length(strtosend);
    copyDataStruct.lpData := PChar(strtosend);

    receiverHandle := FindWindow(nil, PChar(title));

    if receiverHandle <> 0 then
    begin
      SendMessageTimeOut(receiverHandle, WM_COPYDATA, Integer(sender), Integer(@copyDataStruct), SMTO_NORMAL or SMTO_ABORTIFHUNG, 100, res);
    end;

  except
    on e: exception do
    begin

    end;
  end;
end;


function GetWindowTitle(HWND: THandle): string;
var
  Buffer: array[0..255] of Char;
begin
  SetString(Result, Buffer, GetWindowText(HWND, Buffer, Length(Buffer)));
end;

function GetWindowClassName(HWND: THandle): string;
var
  Buffer: array[0..255] of Char;
begin
  SetString(Result, Buffer, GetClassName(HWND, Buffer, Length(Buffer)));
end;


procedure wm_sendstringex(sender: HWND; target: hwnd; strtosend: string);
var
  copyDataStruct: TCopyDataStruct;
  res: pdword_ptr;
begin

  if not iswindow(sender) then begin
     outputdebugstring(pchar('sendstring: sender hwnd is invalid'));
    exit;
  end;

  if not iswindow(target) then begin
     outputdebugstring(pchar('sendstring: target hwnd is invalid'));
    exit;
  end;

    outputdebugstring(pchar(GetWindowClassName(target)));
    outputdebugstring(pchar(GetWindowTitle(target)));

    outputdebugstring(pchar(strtosend));

    CopyDataStruct.dwData := 1;
    CopyDataStruct.cbData := (Length(strtosend) + 1) * SizeOf(Char);
    CopyDataStruct.lpData := PChar(strtosend);
    SendMessage(target, WM_COPYDATA, 0, LPARAM(@CopyDataStruct));
end;

end.

